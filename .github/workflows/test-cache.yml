name: Test Cache Strategy

on:
  workflow_dispatch:

jobs:
  test-cache:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Restore cache
      - name: Restore Abseil Cache
        id: cache-abseil-restore
        uses: actions/cache/restore@v3
        with:
          path: |
            abseil-cpp
            ~/deps/abseil
          key: test-abseil-android-arm64-v1
          restore-keys: |
            test-abseil-android-arm64-

      - name: Setup NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          unzip -q android-ndk-r25b-linux.zip
          export ANDROID_NDK_HOME=$PWD/android-ndk-r25b
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV

      - name: Download Abseil
        if: steps.cache-abseil-restore.outputs.cache-hit != 'true'
        run: |
          echo "Downloading Abseil..."
          git clone https://github.com/abseil/abseil-cpp.git

      - name: Build Abseil
        if: steps.cache-abseil-restore.outputs.cache-hit != 'true'
        run: |
          cd abseil-cpp
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_INSTALL_PREFIX=$HOME/deps/abseil
          make -j$(nproc)
          make install
          echo "âœ… Abseil built successfully!"

      # CRITICAL: Save cache immediately after build
      - name: Save Abseil Cache
        if: steps.cache-abseil-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            abseil-cpp
            ~/deps/abseil
          key: test-abseil-android-arm64-v1

      - name: Verify Cache
        run: |
          echo "Cache saved! Testing restore..."
          ls -la ~/deps/abseil || echo "Directory not found"

      # Simulate failure to test cache persistence
      - name: Test Failure (Optional)
        run: |
          echo "Simulating failure to test cache..."
          # exit 1  # Uncomment to test cache on failure
