name: Build Cartographer for Android (Cache Save Strategy)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==================================
      # # Cache Android NDK
      # ==================================
      - name: Cache Android NDK
        id: cache-ndk
        uses: actions/cache@v3
        with:
          path: android-ndk-r25b
          key: android-ndk-r25b-${{ runner.os }}

      - name: Install Android NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          unzip -q android-ndk-r25b-linux.zip
          rm android-ndk-r25b-linux.zip

      - name: Set NDK Environment
        run: |
          export ANDROID_NDK_HOME=$PWD/android-ndk-r25b
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git wget unzip

      # ==================================
      # Abseil with cache/save
      # ==================================
      - name: Restore Abseil Cache
        id: cache-abseil-restore
        uses: actions/cache/restore@v3
        with:
          path: |
            abseil-cpp
            ~/deps/abseil
          key: abseil-v2-${{ runner.os }}
          restore-keys: abseil-v2-

      - name: Build Abseil
        if: steps.cache-abseil-restore.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/abseil/abseil-cpp.git
          cd abseil-cpp
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_INSTALL_PREFIX=$HOME/deps/abseil
          make -j$(nproc)
          make install
          echo "✅ Abseil built!"

      - name: Save Abseil Cache
        if: steps.cache-abseil-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            abseil-cpp
            ~/deps/abseil
          key: abseil-v2-${{ runner.os }}

      # ==================================
      # Protobuf with cache/save
      # ==================================
      - name: Restore Protobuf Cache  
        id: cache-protobuf-restore
        uses: actions/cache/restore@v3
        with:
          path: |
            protobuf
            ~/deps/protobuf
            ~/deps/protobuf-host
          key: protobuf-v2-${{ runner.os }}
          restore-keys: protobuf-v2-

      - name: Build Protobuf
        if: steps.cache-protobuf-restore.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/protocolbuffers/protobuf.git
          cd protobuf
          git checkout v3.19.0
          # Host build for protoc
          mkdir -p build-host && cd build-host
          cmake ../cmake -Dprotobuf_BUILD_TESTS=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_STANDARD=17 -DCMAKE_INSTALL_PREFIX=$HOME/deps/protobuf-host
          make -j$(nproc)
          make install
          cd ..
          # Android build
          mkdir -p build && cd build
          cmake ../cmake \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-21 \
            -Dprotobuf_BUILD_TESTS=OFF \
            -Dprotobuf_BUILD_PROTOC_BINARIES=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -Dprotobuf_PROTOC_EXECUTABLE=$HOME/deps/protobuf-host/bin/protoc \
            -DCMAKE_INSTALL_PREFIX=$HOME/deps/protobuf
          make -j$(nproc)
          make install
          echo "✅ Protobuf built!"

      - name: Save Protobuf Cache
        if: steps.cache-protobuf-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            protobuf
            ~/deps/protobuf
            ~/deps/protobuf-host
          key: protobuf-v2-${{ runner.os }}

      # ==================================
      # Eigen with cache/save
      # ==================================
      - name: Restore Eigen Cache
        id: cache-eigen-restore
        uses: actions/cache/restore@v3
        with:
          path: |
            eigen
            ~/deps/eigen
          key: eigen-v2-${{ runner.os }}
          restore-keys: eigen-v2-

      - name: Build Eigen
        if: steps.cache-eigen-restore.outputs.cache-hit != 'true'
        run: |
          git clone https://gitlab.com/libeigen/eigen.git
          cd eigen
          git checkout 3.4.0
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_INSTALL_PREFIX=$HOME/deps/eigen
          make install
          echo "✅ Eigen built!"

      - name: Save Eigen Cache
        if: steps.cache-eigen-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            eigen
            ~/deps/eigen
          key: eigen-v2-${{ runner.os }}

      # ==================================
      # Boost with cache/save
      # ==================================
      - name: Restore Boost Cache
        id: cache-boost-restore
        uses: actions/cache/restore@v3
        with:
          path: |
            boost_1_82_0
            ~/deps/boost
          key: boost-v2-${{ runner.os }}
          restore-keys: boost-v2-

      - name: Build Boost
        if: steps.cache-boost-restore.outputs.cache-hit != 'true'
        run: |
          wget https://sourceforge.net/projects/boost/files/boost/1.82.0/boost_1_82_0.tar.gz/download -O boost_1_82_0.tar.gz
          tar -xzf boost_1_82_0.tar.gz
          cd boost_1_82_0
          ./bootstrap.sh
          echo "using clang : android : $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang++ ;" > user-config.jam
          ./b2 \
            --with-iostreams \
            --with-system \
            --with-filesystem \
            --with-regex \
            --user-config=user-config.jam \
            toolset=clang-android \
            target-os=android \
            architecture=arm \
            address-model=64 \
            link=static \
            variant=release \
            --prefix=$HOME/deps/boost \
            install \
            -j$(nproc) \
            -d0
          echo "✅ Boost built!"

      - name: Save Boost Cache
        if: steps.cache-boost-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            boost_1_82_0
            ~/deps/boost
          key: boost-v2-${{ runner.os }}

      # ==================================
      # Ceres with cache/save
      # ==================================
      - name: Restore Ceres Cache
        id: cache-ceres-restore
        uses: actions/cache/restore@v3
        with:
          path: |
            ceres-solver
            ~/deps/ceres
          key: ceres-v2-${{ runner.os }}
          restore-keys: ceres-v2-

      - name: Build Ceres
        if: steps.cache-ceres-restore.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/ceres-solver/ceres-solver.git
          cd ceres-solver
          git checkout 2.1.0
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-21 \
            -DBUILD_GRPC=OFF \
            -DBUILD_TESTING=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_BENCHMARKS=OFF \
            -DMINIGLOG=ON \
            -DEigen3_DIR=$HOME/deps/eigen/share/eigen3/cmake \
            -DCMAKE_INSTALL_PREFIX=$HOME/deps/ceres
          make -j$(nproc)
          make install
          echo "✅ Ceres built!"

      - name: Save Ceres Cache
        if: steps.cache-ceres-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            ceres-solver
            ~/deps/ceres
          key: ceres-v2-${{ runner.os }}

      # ==================================
      # Lua with cache/save
      # ==================================
      - name: Restore Lua Cache
        id: cache-lua-restore
        uses: actions/cache/restore@v3
        with:
          path: |
            lua-5.3.6
            ~/deps/lua
          key: lua-v2-${{ runner.os }}
          restore-keys: lua-v2-

      - name: Build Lua
        if: steps.cache-lua-restore.outputs.cache-hit != 'true'
        run: |
          wget https://www.lua.org/ftp/lua-5.3.6.tar.gz
          tar -xzf lua-5.3.6.tar.gz
          cd lua-5.3.6
          make generic \
            CC="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang" \
            AR="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar rcu" \
            RANLIB="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib" \
            MYCFLAGS="-fPIC" \
            MYLDFLAGS="-fPIC"
          mkdir -p $HOME/deps/lua/include $HOME/deps/lua/lib
          cp src/lua.h src/luaconf.h src/lualib.h src/lauxlib.h src/lua.hpp $HOME/deps/lua/include/
          cp src/liblua.a $HOME/deps/lua/lib/
          echo "✅ Lua built!"

      - name: Save Lua Cache
        if: steps.cache-lua-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            lua-5.3.6
            ~/deps/lua
          key: lua-v2-${{ runner.os }}

      # ==================================
      # Build Cartographer
      # ==================================
      - name: Download Cartographer
        run: |
          if [ ! -d "cartographer" ]; then
            git clone https://github.com/cartographer-project/cartographer.git
          else
            cd cartographer
            git pull
            cd ..
          fi

      - name: Build Cartographer
        run: |
          cd cartographer
          sed -i 's/google_enable_testing()/#google_enable_testing()/g' CMakeLists.txt
          sed -i 's/find_package(Ceres REQUIRED COMPONENTS SuiteSparse)/find_package(Ceres REQUIRED)/g' CMakeLists.txt
          sed -i 's/PKG_SEARCH_MODULE(CAIRO REQUIRED cairo>=1.12.16)/#PKG_SEARCH_MODULE(CAIRO REQUIRED cairo>=1.12.16)/g' CMakeLists.txt
          sed -i '45 a\  return "";' cartographer/common/configuration_file_resolver.cc
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-21 \
            -DBUILD_GRPC=OFF \
            -DBUILD_TESTING=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_FLAGS="-Wno-error -DGUARDED_BY(x)= -DLOCKS_EXCLUDED(x)= -DEXCLUSIVE_LOCKS_REQUIRED(x)= -DLOCK_RETURNED(x)= -DEXCLUDES(x)= -DNO_THREAD_SAFETY_ANALYSIS=" \
            -Dabsl_DIR=$HOME/deps/abseil/lib/cmake/absl \
            -DProtobuf_DIR=$HOME/deps/protobuf/lib/cmake/protobuf \
            -DProtobuf_INCLUDE_DIR=$HOME/deps/protobuf/include \
            -DProtobuf_LIBRARY=$HOME/deps/protobuf/lib/libprotobuf.a \
            -DProtobuf_PROTOC_EXECUTABLE=$HOME/deps/protobuf-host/bin/protoc \
            -DEigen3_DIR=$HOME/deps/eigen/share/eigen3/cmake \
            -DCeres_DIR=$HOME/deps/ceres/lib/cmake/Ceres \
            -DBOOST_ROOT=$HOME/deps/boost \
            -DBoost_INCLUDE_DIR=$HOME/deps/boost/include \
            -DBoost_LIBRARY_DIR=$HOME/deps/boost/lib \
            -DBoost_USE_STATIC_LIBS=ON \
            -DLUA_INCLUDE_DIR=$HOME/deps/lua/include \
            -DLUA_LIBRARIES=$HOME/deps/lua/lib/liblua.a \
            -DCMAKE_INSTALL_PREFIX=$PWD/install
          make -j$(nproc)
          make install

      - name: Archive build artifacts
        run: |
          tar -czf cartographer-android-build.tar.gz cartographer/build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: cartographer-android-build
          path: cartographer-android-build.tar.gz
